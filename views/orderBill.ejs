<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/head.ejs') %>
  <title>Order Bill</title>
  <%- include('./styles/orderBill.ejs') %>
</head>
<body>
  <nav class="navbar">
    <img src="/Images/logo.png" alt="Scan N Order Logo" class="logo">
    <span class="nav-title">SCAN N ORDER</span>
  </nav>
  <div class="container">
    <% if (locals.user) { %>
      <h2>Order Successful !!</h2>
      <div class="order-box" id="bill-container">
        <div class="order-details">
          <div class="user-details">
            <p><strong>Name:</strong> <%= user.userName %></p>
            <p><strong>Date:</strong> <%= new Date().toLocaleDateString() %></p>
            <p><strong>Time:</strong> <%= new Date().toLocaleTimeString() %></p>
          </div>
          <button class="download-btn">Download Bill</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
              <% let totalPrice = 0; %> <% let gst = 0; %> <% let serviceTip = 0; %> 
              <% UserItems.forEach(item => {
         totalPrice +=Number(item.price) * Number(item.quantity); %> 
                <tr>
                  <td><%= item.name %></td>
                  <td><%= item.quantity %></td>
                  <td>‚Çπ<%= item.price %></td>
                  <td>‚Çπ<%= item.amt %></td>
                </tr>
              <% }); %>
              <tr>
                <td colspan="3"><strong>Total</strong></td>
                <td>‚Çπ <%= UserItems.reduce((total, item) => total + item.amt, 0) %></td>
              </tr>
            </tbody>
        </table>
<% gst = totalPrice * 0.18; %> <% serviceTip = totalPrice *
        0.10; %>
  <p style="text-align: right;">Items Total: ‚Çπ<%= totalPrice.toFixed(2) %></p>
  <p style="text-align: right;">GST (18%): ‚Çπ<%= gst.toFixed(2) %></p>
  <p style="text-align: right;">Service Tip (10%): ‚Çπ<%= serviceTip.toFixed(2) %></p>

  <hr>
  <h3 style="text-align: right; font-size: 20px; font-weight: 500;">Grand Total: ‚Çπ<%= (totalPrice + gst + serviceTip).toFixed(2) %></h3>
  
  <hr>
        <h3>Thank you! üôè</h3>
      </div>
      <% } %>
      <form action="/" method="get">
        <button class="home-btn">
          <i class="fa-solid fa-house fa-xl" style="color: #ffffff;"></i>
         </button>
         <div style="color: #D8222F;">Back to Home</div>
      </form>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
<script>
  window.onload = function () {
    const downloadBtn = document.querySelector('.download-btn');
    const billNode = document.getElementById('bill-container');

    if (!downloadBtn || !billNode) return;

    downloadBtn.addEventListener('click', function () {
      downloadBtn.style.display = 'none';
      billNode.style.border = 'none';

      setTimeout(() => {
        domtoimage.toPng(billNode)
          .then(function (dataUrl) {
            const link = document.createElement('a');
            link.download = 'order-bill.png';
            link.href = dataUrl;
            link.click();

            downloadBtn.style.display = 'inline-block';
            billNode.style.border = '2px solid red'; 
          })
          .catch(function (error) {
            console.error('Error generating image:', error);

            downloadBtn.style.display = 'inline-block';
            billNode.style.border = '2px solid red';
          });
      }, 10);
    });
  };
</script>

  <%- include('./scripts/orderBill.ejs') %>
  <%- include('./partials/script.ejs') %>
  <script src="https://kit.fontawesome.com/04b7df36b9.js" crossorigin="anonymous"></script>  
  

</body>
</html>